name: Setup Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  validate:
    name: Validate Repository Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          echo "üîç Checking required files..."
          REQUIRED_FILES=(
            "README.md"
            ".github/workflows/setup-validation.yml"
            ".github/workflows/security-scan.yml"
            ".github/workflows/code-quality.yml"
            "scripts/setup-marketplace-apps.sh"
            "docs/SETUP_GUIDE.md"
          )
          
          MISSING=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ö†Ô∏è Missing: $file"
              MISSING=1
            else
              echo "‚úÖ Found: $file"
            fi
          done
          
          if [ $MISSING -eq 1 ]; then
            echo "‚ùå Some required files are missing"
            exit 1
          fi
          
          echo "‚úÖ All required files present"

      - name: Validate directory structure
        run: |
          echo "üîç Validating directory structure..."
          REQUIRED_DIRS=(
            ".github/workflows"
            ".github/hooks"
            "scripts"
            ".opencode/agents"
            "mcp"
            "docs"
          )
          
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "‚ö†Ô∏è Missing directory: $dir"
              exit 1
            else
              echo "‚úÖ Found directory: $dir"
            fi
          done

      - name: Check secrets availability
        run: |
          echo "üîç Checking secrets configuration..."
          echo "Note: Actual secret values are not exposed in logs"
          
          # Check if secrets template exists
          if [ -f ".github/secrets-template.env" ]; then
            echo "‚úÖ Secrets template found"
          else
            echo "‚ö†Ô∏è Secrets template not found"
          fi

      - name: Validate workflow files
        run: |
          echo "üîç Validating workflow files..."
          for workflow in .github/workflows/*.yml; do
            echo "Checking $workflow..."
            if ! grep -q "on:" "$workflow"; then
              echo "‚ùå Invalid workflow: $workflow"
              exit 1
            fi
            echo "‚úÖ Valid: $workflow"
          done

      - name: Report status
        run: |
          echo "‚úÖ Repository structure validation complete"
          echo "üìä Summary:"
          echo "  - Required files: Present"
          echo "  - Directory structure: Valid"
          echo "  - Workflows: Valid"
