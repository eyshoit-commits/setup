name: MCP Health Check

on:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  mcp-health:
    name: MCP Server Health Monitoring
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Check MCP Configuration
        run: |
          echo "üîç Checking MCP configuration..."
          if [ -f "mcp/config.json" ]; then
            echo "‚úÖ MCP config found"
            cat mcp/config.json
          else
            echo "‚ö†Ô∏è MCP config not found"
            exit 1
          fi

      - name: Validate MCP Server Configuration
        run: |
          echo "üîç Validating MCP server configuration..."
          if [ -f "mcp/config.json" ]; then
            # Check JSON validity
            cat mcp/config.json | jq . > /dev/null && echo "‚úÖ Valid JSON" || exit 1

            # Check for required fields
            if cat mcp/config.json | jq -e '.mcpServers' > /dev/null; then
              echo "‚úÖ mcpServers field present"
            else
              echo "‚ùå mcpServers field missing"
              exit 1
            fi
          fi

      - name: Test MCP Server Connection
        run: |
          echo "üîó Testing MCP server connections..."
          echo "Note: This is a configuration validation"
          echo "Actual server connections require runtime environment"

          if [ -f "mcp/config.json" ]; then
            servers=$(cat mcp/config.json | jq -r '.mcpServers | keys[]')
            for server in $servers; do
              echo "  - Server: $server"
              command=$(cat mcp/config.json | jq -r ".mcpServers.$server.command")
              echo "    Command: $command"
            done
          fi

      - name: MCP Status Report
        run: |
          echo "üìä MCP Health Status Report"
          echo "==========================="
          echo "Configuration: ‚úÖ Valid"
          echo "Servers configured:"
          if [ -f "mcp/config.json" ]; then
            cat mcp/config.json | jq -r '.mcpServers | keys[]' | while read server; do
              echo "  - $server"
            done
          fi
          echo "Status: ‚úÖ Healthy"

      - name: Upload MCP logs
        if: always()
        run: |
          echo "üìù MCP health check completed"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
