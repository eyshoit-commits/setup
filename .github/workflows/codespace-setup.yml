name: ðŸš€ Codespace Setup

on:
  push:
    branches: [main, develop]
  pull_request:
  workflow_dispatch:
  # Trigger on codespace lifecycle events
  codespace:
    types: [created, started]

jobs:
  setup-validation:
    name: Validate Setup Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run validation
        run: bash scripts/validate.sh

      - name: Run setup
        run: bash scripts/setup.sh

      - name: Run smoke tests
        run: bash scripts/smoke-test.sh

      - name: Upload setup report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: setup-report
          path: setup-report.json

      - name: Upload MCP context
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mcp-context
          path: .mcp/context.json

  setup-windows:
    name: Setup on Windows
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run validation
        run: powershell -File scripts/validate.ps1

      - name: Run setup
        run: powershell -File scripts/setup.ps1

      - name: Run smoke tests
        run: powershell -File scripts/smoke-test.ps1
        continue-on-error: true

      - name: Upload setup report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: setup-report-windows
          path: setup-report.json

  setup-macos:
    name: Setup on macOS
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run validation
        run: bash scripts/validate.sh

      - name: Run setup
        run: bash scripts/setup.sh

      - name: Run smoke tests
        run: bash scripts/smoke-test.sh

      - name: Upload setup report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: setup-report-macos
          path: setup-report.json

  codespace-init:
    name: Initialize Codespace Environment
    runs-on: ubuntu-latest
    if: github.event_name == 'codespace'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Display codespace info
        run: |
          echo "ðŸš€ Setting up Codespace..."
          echo "Event: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Codespace: ${{ github.event.codespace.name }}"
      
      - name: Install development tools
        run: |
          echo "ðŸ“¦ Installing development tools..."
          
          # Update package lists
          sudo apt-get update
          
          # Install essential tools
          sudo apt-get install -y \
            git \
            curl \
            wget \
            jq \
            build-essential \
            python3 \
            python3-pip
          
          echo "âœ“ Base tools installed"
      
      - name: Run setup scripts
        run: |
          echo "ðŸ”§ Running setup scripts..."
          
          # Validate first
          bash scripts/validate.sh
          
          # Run setup
          bash scripts/setup.sh
          
          echo "âœ“ Setup complete"
      
      - name: Validate environment
        run: |
          echo "âœ… Validating environment..."
          
          # Run smoke tests
          bash scripts/smoke-test.sh
          
          echo "âœ“ Validation complete"
      
      - name: Generate agent handshake
        run: |
          echo "ðŸ¤ Generating agent handshake..."
          
          # Create MCP context if not exists
          mkdir -p .mcp
          
          if [ ! -f .mcp/context.json ]; then
            cat > .mcp/context.json << 'EOF'
          {
            "environment": "codespace",
            "initialized": true,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "tools_installed": true,
            "agents_available": true
          }
          EOF
          fi
          
          echo "âœ“ Agent handshake generated"
      
      - name: Setup VS Code extensions
        run: |
          echo "ðŸ”Œ Configuring VS Code extensions..."
          
          # Create extensions file if it doesn't exist
          mkdir -p .vscode
          
          if [ ! -f .vscode/extensions.json ]; then
            cat > .vscode/extensions.json << 'EOF'
          {
            "recommendations": [
              "github.copilot",
              "github.copilot-chat",
              "github.vscode-pull-request-github",
              "dbaeumer.vscode-eslint",
              "esbenp.prettier-vscode",
              "eamodio.gitlens"
            ]
          }
          EOF
          fi
          
          echo "âœ“ VS Code extensions configured"
      
      - name: Display welcome message
        run: |
          cat << 'EOF'
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                                                            â•‘
          â•‘  ðŸŽ‰ Codespace Setup Complete!                              â•‘
          â•‘                                                            â•‘
          â•‘  Your development environment is ready.                    â•‘
          â•‘                                                            â•‘
          â•‘  ðŸ“š Documentation: docs/                                   â•‘
          â•‘  ðŸ¤– Agents: .opencode/agents/                              â•‘
          â•‘  ðŸ”§ Tools: Run `bash scripts/smoke-test.sh`                â•‘
          â•‘                                                            â•‘
          â•‘  Happy coding! ðŸš€                                          â•‘
          â•‘                                                            â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          EOF
      
      - name: Upload setup report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: codespace-setup-report
          path: setup-report.json
      
      - name: Upload MCP context
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: codespace-mcp-context
          path: .mcp/context.json
