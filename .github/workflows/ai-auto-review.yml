name: AI-Powered Auto Review & Fix

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  copilot-review:
    name: GitHub Copilot Review
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/review'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }}..HEAD > pr-diff.txt
          echo "diff_size=$(wc -l < pr-diff.txt)" >> $GITHUB_OUTPUT

      - name: AI Code Review Comment
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const diff = fs.readFileSync('pr-diff.txt', 'utf8');

            // Erstelle Review-Kommentar mit AI-Vorschl√§gen
            const reviewComment = `## ü§ñ AI Code Review

            ### Automatische Analyse

            **Gepr√ºfte √Ñnderungen:** ${{ steps.diff.outputs.diff_size }} Zeilen

            ### Empfohlene Verbesserungen

            #### üîí Sicherheit
            - [ ] Keine Secrets/API-Keys im Code
            - [ ] Input-Validierung vorhanden
            - [ ] Sichere Dependencies verwendet

            #### ‚ú® Code-Qualit√§t
            - [ ] Code folgt Style-Guide
            - [ ] Keine TODO/FIXME f√ºr Production
            - [ ] Error-Handling implementiert

            #### üìù Dokumentation
            - [ ] README aktualisiert (falls n√∂tig)
            - [ ] Kommentare f√ºr komplexe Logik
            - [ ] CHANGELOG.md erweitert

            #### üß™ Tests
            - [ ] Unit-Tests hinzugef√ºgt
            - [ ] Smoke-Tests erfolgreich

            ---

            üí° **Tipp:** Schreibe \`/fix\` um automatische Korrekturen anzuwenden.

            üìö **Weitere AI-Tools:**
            - [CodeRabbit](https://github.com/apps/coderabbitai) - Detaillierte Code-Reviews
            - [CodiumAI](https://github.com/apps/codiumai-pr-agent) - Test-Generierung
            - [Copilot](https://github.com/features/copilot) - Code-Vorschl√§ge
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reviewComment
            });

  security-check:
    name: Security & Secrets Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'

  ai-suggestions:
    name: AI Code Suggestions
    runs-on: ubuntu-latest
    needs: [copilot-review]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          echo "üîç Analysiere Code-√Ñnderungen..."
          echo "ü§ñ Generiere AI-Verbesserungsvorschl√§ge..."

      - name: Generate AI suggestions
        uses: actions/github-script@v8
        with:
          script: |
            // Automatische Vorschl√§ge basierend auf h√§ufigen Patterns
            const suggestions = [
              {
                title: "üì¶ Package Updates",
                suggestion: "npm outdated && npm update",
                reason: "Halte Dependencies aktuell"
              },
              {
                title: "üîê Security Audit",
                suggestion: "npm audit fix",
                reason: "Behebe bekannte Vulnerabilities"
              },
              {
                title: "üé® Code Formatting",
                suggestion: "prettier --write .",
                reason: "Konsistenter Code-Style"
              },
              {
                title: "üßπ Linting",
                suggestion: "eslint --fix .",
                reason: "Behebe automatisch fixbare Linting-Fehler"
              }
            ];

            let comment = "## üí° AI-Generierte Verbesserungsvorschl√§ge\n\n";

            suggestions.forEach(s => {
              comment += `### ${s.title}\n`;
              comment += `**Grund:** ${s.reason}\n`;
              comment += `\`\`\`bash\n${s.suggestion}\n\`\`\`\n\n`;
            });

            comment += "---\n";
            comment += "‚úÖ **Auto-Apply:** Diese Vorschl√§ge k√∂nnen automatisch angewendet werden mit `/fix`\n";

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  setup-validation:
    name: Validate Setup Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run validation
        run: |
          if [ -f "scripts/validate.sh" ]; then
            bash scripts/validate.sh
          fi

      - name: Run smoke tests
        run: |
          if [ -f "scripts/smoke-test.sh" ]; then
            bash scripts/smoke-test.sh
          fi

      - name: Post validation results
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ' : '‚ùå';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${status} **Setup Validation:** ${status === '‚úÖ' ? 'Erfolgreich' : 'Fehlgeschlagen'}\n\nDetails siehe [Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });
